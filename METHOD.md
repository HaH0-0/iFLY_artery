## 概览

整体目标：从两张互相垂直的冠脉造影图像中，提取同一血管主干的两条 2D 投影中心线（XOZ 与 YOZ），再交给 3D 参数曲线模型做联合拟合。

---

## 1. 预处理

* 解码：`pydicom` 读取，必要时用 `pylibjpeg`/`gdcm` 解码像素。
* 灰度 & 反相：若 `PhotometricInterpretation=MONOCHROME1`，做反相。
* 归一化：线性归一化到 `[0,1]`；自适应直方图均衡（CLAHE）提升局部对比度；轻度高斯平滑。
* 边框清理：按边缘距裁掉 1–2px 黑边；`clear_border` 去掉刻字/标尺等连通域。

---

## 2. 帧选择

* **优先手动**：若说明文档给了帧号 → 直接 `fixed_frames=(k1,k2)`。
* **自动（轻量）**：在降采样帧上，用

  * 血管度分数（Sato/Meijering 多尺度脊线滤波的 99 分位值），
  * 对比分数（95–5 分位差）
    的加权和打分，粗筛 + 局部精扫，选出最佳帧。

---

## 3. 融合分割

* **DeepSA**：UNet 输出概率 `prob`（支持多角度 + 安全 padding 推理），得到初步二值 mask。
* **血管度**：Sato/Meijering 多尺度响应 `vesselness`。
* **融合**：分层阈值（高置信 prob 直接保留；中置信需 vesselness 支持；低置信需更强 vesselness），再小形态学清理、`remove_small_objects`、轻度开闭，最后 `clear_border`。
* **连通性修补**：仅在 vesselness 足够的位置进行少量连接（避免过度扩张）。

---

## 4. 主干中心线

两套策略自动兜底：

1. **测地主干**

   * 代价图：

     $$
     \text{cost} = \alpha\,(1-\text{DT}) + \beta\,(1-\text{prob})
     $$

     其中 DT 是 mask 的距离变换（半径大更优），`prob` 来自 DeepSA；mask 外赋大代价。
   * 起点：优先选**画面边缘**的端点（接近冠脉入口），并在这些候选里挑 DT 最大者作为起点。
   * 终点：遍历若干端点，计算测地路径总成本并以**中位半径**为次级准则择优；长度不足时回退为最长欧氏长度。
   * 参数：`alpha≈0.9~0.95`（更贴合粗干），`beta≈0.1~0.2`（信任 DeepSA），候选终点数 `n_end_candidates` 可增大以增强鲁棒性。

2. **骨架最长路径（默认）**

   * `skeletonize` → 迭代修剪短刺枝 → 端点对中找**最远测地**；
   * 适合 DeepSA 概率较弱或分割断裂较多的情况。

二者输出的 `(row, col)` 点序列都按路径顺序重采样为**等弧长采样**（平滑后统一点数），增强后续投影与拟合的稳定性。

---

## 5. 投影与坐标

* 像素 → 物理：用 DICOM `PixelSpacing` 将 row/col 转换为 mm。
* `planes`：声明两个视图分别是 XOZ 还是 YOZ（决定第二列是 x 还是 y）。
* **z 轴选择**：

  * 默认 `z=row(mm)`（常见 C 臂布置下满足单调深度）；
  * 可选 `z=弧长(mm)`（对轻微非单调/摆动更稳）。
* 输出：

  * `xoz.csv`：`[z, x]`
  * `yoz.csv`：`[z, y]`

---

## 6. 精简版 3D 拟合（`fit_parametric_3d_multistart` 思想）

**问题**：给定两投影 `XOZ(z,x)` 与 `YOZ(z,y)`，拟合单一 3D 参数模型

$$
x(t)=a t+b\sin(ct),\;
y(t)=d t+e\cos(ft),\;
z(t)=g t+h\sin(it),
$$

在统一的参数 $t\in[0,1]$ 下**联合**匹配两个投影。

**数据整理**：

* 将两条曲线按 z 的**交集区间**重采样到统一 z 网格；
* 令 $t=(z-z_{\min})/(z_{\max}-z_{\min})$，得到 $(X_g(t),Y_g(t),Z_g(t)=z)$。

**目标函数**：

* 轴权重 $w_x,w_y,w_z\propto 1/\text{Var}$（和≈3）；
* 残差 $r_x,r_y,r_z$（按权重）；
* **z 单调软惩罚**：当 $z'(t)<\varepsilon$ 时加罚，抑制 z 回头。

**初始化与边界**：

* 每轴先做线性趋势 + 对残差 FFT 估主频；
* 斜率给宽界，幅度按轴范围倍数限制（默认 2×），频率上限（如 $6\pi$）。

**单次优化**：TRF 有界最小二乘。

**多启动**：

* 扫多个频率上限与单调惩罚组合；
* 每组做若干带抖动的初值；
* 取 **RMS 最小**（并参考 ISE 打平）。

**输出**：拟合参数 JSON、采样 CSV、三轴对比图与 3D 曲线图。
**指标**：RMS（3D 均方根）、ISE（$\int_0^1 \|\Delta(t)\|^2 dt$ 的数值近似）。

---

## 7. 关键超参与权衡

* 分割：`min_object_area≈300~600`，`open_disk_radius≈1~2`；DeepSA 建议开启多角度/安全 padding。
* 主干：`alpha` 大 → 更贴合粗干；`beta` 大 → 更依赖 DeepSA 概率；`n_end_candidates` 增大会更稳但更慢。
* 投影：`z=row` 更直观，`z=arc` 更稳健。
* 拟合：`n_grid=1000~3000`，`freq_hi=4π~10π`，`monotone_penalty=10~60`，`n_starts=20~60`。

---

## 8. 复杂度与时间

* 分割与中心线：取决于图像大小与是否启用 DeepSA，通常数百毫秒到数秒每视图。
* 多启动拟合：近似线性增长于 `n_starts × 组合数 × n_grid`；调小 `n_starts` 或 `n_grid` 可降时。

---

## 9. 误差度量

* **RMS**：

  $$
  \sqrt{\frac{1}{N}\sum_k[(x\!-\!X_g)^2+(y\!-\!Y_g)^2+(z\!-\!Z_g)^2]}
  $$
* **ISE**：在均匀 $t$-网格上用梯形法近似 $\int_0^1 \|\Delta(t)\|^2 dt$。


---

**到此为止**：

* 使用者只需准备两张互相垂直的 DICOM、可选的 DeepSA 权重、以及 `planes/fixed_frames` 配置，即可一键输出 CSV 并完成 3D 拟合与可视化。
